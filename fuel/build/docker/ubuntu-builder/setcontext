#!/bin/bash
##############################################################################
# Copyright (c) 2015 Ericsson AB and others.
# stefan.k.berg@ericsson.com
# jonas.bjurel@ericsson.com
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
#
SETUSER=$1
SETUID=$2
SETGID=$3
SETHOME=$4

# Handle proxy settings passed to the context
env | egrep -i 'proxy|RSYNC_CONNECT_PROG' | sed 's/^/export /' >> /etc/environment

if [ -n "$http_proxy" ]; then
    echo "Acquire::http::proxy \"$http_proxy\";" >> /etc/apt/apt.conf
    echo "proxy = $http_proxy" >> /etc/npmrc
fi
if [ -n "$https_proxy" ]; then
    echo "Acquire::https::proxy \"$https_proxy\";" >> /etc/apt/apt.conf
    echo "strict-ssl = false" >> /etc/npmrc
    echo "registry = http://registry.npmjs.org/" >> /etc/npmrc
fi

getent group $SETUSER || /usr/sbin/groupadd --gid $SETGID $SETUSER
getent passwd $SETUSER || /usr/sbin/adduser --system --uid=$SETUID --gid=$SETGID --home $SETHOME --shell /bin/bash $SETUSER
/usr/sbin/usermod -a -G fuse $SETUSER
exit 0
