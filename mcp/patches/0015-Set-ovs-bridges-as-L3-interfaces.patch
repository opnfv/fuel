::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
: Copyright (c) 2018 Mirantis Inc., Enea AB and others.
:
: All rights reserved. This program and the accompanying materials
: are made available under the terms of the Apache License, Version 2.0
: which accompanies this distribution, and is available at
: http://www.apache.org/licenses/LICENSE-2.0
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
From: Michael Polenchuk <mpolenchuk@mirantis.com>
Date: Wed, 28 Feb 2018 17:54:28 +0400
Subject: [PATCH] Set ovs bridges as L3 interfaces

Change-Id: I1e83129cc184cf481bea21d7aa452bf60d9e0499

diff --git a/linux/files/ovs_bridge b/linux/files/ovs_bridge
new file mode 100644
index 0000000..c23b2a7
--- /dev/null
+++ b/linux/files/ovs_bridge
@@ -0,0 +1,14 @@
+auto {{ port_name }}
+allow-ovs {{ port_name }}
+iface {{ port_name }} inet {{ port.get('proto', 'manual') }}
+  ovs_type OVSBridge
+  {%- if port.get('proto', 'manual') == 'static' %}
+  address {{ port.address }}
+  netmask {{ port.netmask }}
+  {%- endif %}
+  {%- if port.gateway is defined %}
+  gateway {{ port.gateway }}
+  {%- endif %}
+  {%- if port.ovs_options is defined %}
+  ovs_options {{ port.ovs_options }}
+  {%- endif %}
diff --git a/linux/network/interface.sls b/linux/network/interface.sls
index 7375b04..0f5beb3 100644
--- a/linux/network/interface.sls
+++ b/linux/network/interface.sls
@@ -67,6 +67,24 @@ remove_cloud_init_file:
 ovs_bridge_{{ interface_name }}:
   openvswitch_bridge.present:
   - name: {{ interface_name }}
+  file.managed:
+  - name: /etc/network/interfaces.u/ifcfg-{{ interface_name }}
+  - makedirs: True
+  - source: salt://linux/files/ovs_bridge
+  - defaults:
+      port: {{ interface|yaml }}
+      port_name: {{ interface_name }}
+  - template: jinja
+
+ovs_bridge_up_{{ interface_name }}:
+  cmd.run:
+  - name: ifup {{ interface_name }}
+  - require:
+    - file: ovs_bridge_{{ interface_name }}
+    - openvswitch_bridge: ovs_bridge_{{ interface_name }}
+    - file: linux_interfaces_final_include
+  - unless:
+    - ip link show {{ interface_name }} | grep -q '\<UP\>'

 {# add linux network interface into OVS bridge #}
 {%- for int_name, int in network.interface.items() %}
