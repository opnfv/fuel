::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
: Copyright (c) 2018 Mirantis Inc., Enea AB and others.
:
: All rights reserved. This program and the accompanying materials
: are made available under the terms of the Apache License, Version 2.0
: which accompanies this distribution, and is available at
: http://www.apache.org/licenses/LICENSE-2.0
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
From: Michael Polenchuk <mpolenchuk@mirantis.com>
Date: Wed, 28 Feb 2018 17:54:28 +0400
Subject: [PATCH] Set ovs bridges as L3 interfaces

diff --git a/linux/files/ovs_bridge b/linux/files/ovs_bridge
index bf9b74f..c45d459 100644
--- a/linux/files/ovs_bridge
+++ b/linux/files/ovs_bridge
@@ -1,4 +1,5 @@
 auto {{ bridge_name }}
+allow-ovs {{ bridge_name }}
 iface {{ bridge_name }} inet {{ bridge.get('proto', 'static' if bridge.address is defined else 'manual') }}
 ovs_type {{ bridge.get('ovs_bridge_type', 'OVSBridge') }}
 mtu {{ bridge.get('mtu', '1500') }}
@@ -12,3 +13,12 @@ gateway {{ bridge.gateway }}
 {%- if bridge.ovs_options is defined %}
 ovs_options {{ bridge.ovs_options }}
 {%- endif %}
+{%- if bridge.use_interfaces is defined %}
+ovs_ports {{ bridge.use_interfaces|join(' ') }}
+{%- endif %}
+{%- if bridge.datapath_type is defined %}
+ovs_extra set Bridge ${IFACE} datapath_type={{ bridge.datapath_type }}
+{%- endif %}
+{%- if bridge.name_servers is defined %}
+dns-nameservers {{ bridge.name_servers | join(' ') }}
+{%- endif %}
diff --git a/linux/files/ovs_port b/linux/files/ovs_port
index a55b821..cbc85cd 100644
--- a/linux/files/ovs_port
+++ b/linux/files/ovs_port
@@ -1,6 +1,11 @@
-auto {{ port_name }}
+# With systemd, adding OVS bridges as 'auto' can cause race conditions
+# https://github.com/openvswitch/ovs/blob/master/debian/openvswitch-switch.README.Debian
+# auto {{ port_name }}
 allow-{{ port.bridge }} {{ port_name }}
 iface {{ port_name }} inet {{ port.get('proto', 'manual') }}
+{%- if '.' in port_name %}
+vlan-raw-device {{ port_name.split('.')[0] }}
+{%- endif %}
 ovs_type {{ port.get('ovs_port_type', 'OVSIntPort') }}
 mtu {{ port.get('mtu', '1500') }}
 ovs_bridge {{ port.bridge }}
diff --git a/linux/network/interface.sls b/linux/network/interface.sls
index 65e7bb8..6a2526a 100644
--- a/linux/network/interface.sls
+++ b/linux/network/interface.sls
@@ -115,6 +115,9 @@ dpdk_ovs_bridge_{{ interface_name }}:
 dpdk_ovs_bridge_up_{{ interface_name }}:
   cmd.run:
   - name: ifup {{ interface_name }}
+  {%- if network.noifupdown|d(false) or interface.noifupdown|d(false) %}
+  - onlyif: /bin/false
+  {%- endif %}
   - require:
     - file: dpdk_ovs_bridge_{{ interface_name }}
     - file: linux_interfaces_final_include
@@ -166,10 +169,16 @@ ovs_bridge_{{ interface_name }}:

 ovs_bridge_up_{{ interface_name }}:
   cmd.run:
-  - name: ifup {{ interface_name }}
+  - name: ifup --ignore-errors {{ interface_name }}
+  {%- if network.noifupdown|d(false) or interface.noifupdown|d(false) %}
+  - onlyif: /bin/false
+  {%- endif %}
   - require:
+    - openvswitch_bridge: ovs_bridge_{{ interface_name }}
     - file: ovs_bridge_{{ interface_name }}
     - file: linux_interfaces_final_include
+  - unless:
+    - ip link show {{ interface_name }} | grep -q '\<UP\>'



@@ -230,6 +239,9 @@ ovs_port_{{ interface_name }}:
 ovs_port_up_{{ interface_name }}:
   cmd.run:
   - name: ifup {{ interface_name }}
+  {%- if network.noifupdown|d(false) or interface.noifupdown|d(false) %}
+  - onlyif: /bin/false
+  {%- endif %}
   - require:
     - file: ovs_port_{{ interface_name }}
     - openvswitch_bridge: ovs_bridge_{{ interface.bridge }}_present
