#!/bin/bash -e
##############################################################################
# Copyright (c) 2017 Mirantis Inc., Enea AB and others.
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

CI_DEBUG=${CI_DEBUG:-0}; [[ "${CI_DEBUG}" =~ (false|0) ]] || set -x

netmask2cidr() { #Dec to binary and count-the-ones conversion
  set -- ${1//./ }
  binary=({0..1}{0..1}{0..1}{0..1}{0..1}{0..1}{0..1}{0..1})
  echo ${binary[$1]}${binary[$2]}${binary[$3]}${binary[$4]}  | grep -o 1 | wc -l
}

# Determine public network based on external IPs from compute node
PUBLIC_NET=$(salt -C 'I@nova:compute and *01*' \
  pillar.get _param:opnfv_net_public --out yaml | cut -d' ' -f2 )
PUBLIC_NET_MASK=$(salt -C 'I@nova:compute and *01*' \
  pillar.get _param:opnfv_net_public_mask --out yaml | cut -d' ' -f2 )
PUBLIC_NET_GATEWAY=$(salt -C 'I@nova:compute and *01*' \
  pillar.get _param:opnfv_net_public_gw --out yaml | cut -d' ' -f2 )

# Default values
[ -n "${PUBLIC_NET}" ] PUBLIC_NET="10.16.0.0"
[ -n "${PUBLIC_NET_MASK}" ] PUBLIC_NET_MASK="255.255.255.0"
[ -n "${PUBLIC_NET_GATEWAY}" ] PUBLIC_NET_GATEWAY="10.16.0.1"

# Get CIDR notation
CIDR_MASK=$(netmask2cidr $PUBLIC_NET_MASK)
PUBLIC_NET_CIDR="$PUBLIC_NET/$CIDR_MASK"

# Define public pool range.
# For netmask /27 and larger, decrease the pool size here (/27 allows max 30 ips)
POOL_SIZE=40
POOL_START=20
POOL_START_IP="${PUBLIC_NET%.*}.$POOL_START"
POOL_END_IP="${PUBLIC_NET%.*}.$(($POOL_START+$POOL_SIZE))"


# Print openstack status and setup network
salt -C 'I@nova:controller and *01*' cmd.run ". /root/keystonercv3; \
  openstack compute service list; \
  openstack network agent list; \
  openstack stack list; \
  openstack volume service list"
salt -C 'I@nova:controller and *01*' cmd.run ". /root/keystonercv3; \
  openstack network create --external --default --provider-network-type flat \
    --provider-physical-network physnet1 floating_net"
salt -C 'I@nova:controller and *01*' cmd.run ". /root/keystonercv3; \
  openstack subnet create --subnet-range ${PUBLIC_NET_CIDR} --no-dhcp \
    --allocation-pool start=${POOL_START_IP},end=${POOL_END_IP} \
    --gateway ${PUBLIC_NET_GATEWAY} --network floating_net floating_subnet"
